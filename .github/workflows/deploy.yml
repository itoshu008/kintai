name: Deploy to VPS (Minimal Safe)
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      APP_DIR: /home/zatint1991-hvt55/zatint1991.com
      BACKEND_DIR: /home/zatint1991-hvt55/zatint1991.com/backend
      FRONTEND_DIR: /home/zatint1991-hvt55/zatint1991.com/frontend
      PUBLIC_DIR: /home/zatint1991-hvt55/zatint1991.com/public/admin-dashboard-2024
      PM2_APP: kintai-api
      PM2_HOME: /home/itoshu/.pm2
      PORT: "8001"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add host key
        run: |
          set -Eeuo pipefail
          mkdir -p ~/.ssh
          ssh-keygen -R "$VPS_HOST" 2>/dev/null || true
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy (backend â†’ gates â†’ frontend â†’ nginx)
        run: |
          set -Eeuo pipefail
          ssh "$VPS_USER@$VPS_HOST" <<EOF
          set -Eeuo pipefail

          echo "ðŸ“ Ensure directories..."
          mkdir -p "$APP_DIR/scripts" "$BACKEND_DIR" "$FRONTEND_DIR" "$PUBLIC_DIR"

          echo "ðŸ”„ Sync repo (rsync safest)"
          # actions/checkout æ¸ˆã¿ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å…¨ä½“ã‚’ rsync ã—ã¦ã‚‚è‰¯ã„ãŒã€
          # ã“ã“ã§ã¯ã‚µãƒ¼ãƒå´ã®Gitã‚’ä½¿ã‚ãšã€æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã«å¯¾ã— rsync ã§å·®åˆ†åæ˜ ã™ã‚‹ä¾‹
          # â†’ ã‚·ãƒ³ãƒ—ãƒ«ã« git pull ã—ãŸã„å ´åˆã¯ä¸‹ã‚’ä½¿ç”¨:
          # cd "$APP_DIR" && git fetch origin && git reset --hard origin/main
          # ã“ã“ã§ã¯å®‰å…¨å„ªå…ˆã§ rsync ä¾‹ã«åˆ‡æ›¿ã—ãŸã„å ´åˆã¯åˆ¥ã‚¹ãƒ†ãƒƒãƒ—ã§scp/rsyncã—ã¦ãã ã•ã„

          echo "ðŸš€ Backend: install â†’ build â†’ prune"
          cd "$BACKEND_DIR"
          # lockå°Šé‡ã€‚ã‚ºãƒ¬ãŸã‚‰è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          npm ci --include=dev --no-audit --no-fund || npm install --include=dev --no-audit --no-fund
          npm run build
          npm prune --omit=dev

          echo "ðŸŸ¢ PM2 start from config (deleteâ†’start)"
          export PM2_HOME="$PM2_HOME"
          pm2 delete "$PM2_APP" || true
          # â˜… å¿…ãš config ã‹ã‚‰ã€‚script ã¯ dist/server.js ã‚’æŒ‡ã™ã“ã¨
          pm2 start "$BACKEND_DIR/pm2.config.cjs" --only "$PM2_APP"
          pm2 save

          echo "ðŸ§ª Backend gates: LISTEN(IPv4/IPv6) & HEALTH(3x)"
          # LISTEN: sport ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆIPv4/IPv6å¯¾å¿œï¼‰
          for j in 1 2 3; do
            ss -H -ltn "( sport = :$PORT )" | grep -q . && ok=1 || ok=0
            [ "\$ok" = "1" ] && break
            sleep 1
          done
          [ "\$ok" = "1" ] || { echo "âŒ listen NG :$PORT"; tail -n 120 "$PM2_HOME/logs/$PM2_APP-error.log" || true; exit 2; }

          # HEALTH: 3é€£ç¶šOK
          ok=0; streak=0
          for i in 1 2 3 4 5 6 7 8 9 10; do
            if curl -fsS --max-time 10 "http://127.0.0.1:$PORT/api/admin/health" | grep -q '"ok":true'; then
              streak=\$((streak+1)); echo "health OK (\$streak/3)"
              [ \$streak -ge 3 ] && { ok=1; break; }
            else
              streak=0; echo "health NG (reset)"
            fi
            sleep 1
          done
          [ "\$ok" = "1" ] || { echo "âŒ health NG"; tail -n 120 "$PM2_HOME/logs/$PM2_APP-error.log" || true; exit 3; }

          echo "ðŸŽ¨ Frontend: install â†’ build â†’ publish"
          cd "$FRONTEND_DIR"
          npm ci --no-audit --no-fund || npm install --no-audit --no-fund
          npm run build
          rsync -az --delete "$FRONTEND_DIR/dist/" "$PUBLIC_DIR/"
          chown -R itoshu:itoshu "$PUBLIC_DIR"

          echo "âš™ï¸ Nginx: test â†’ reload"
          nginx -t
          systemctl reload nginx

          echo "âœ… Done."
          EOF

      - name: Verify deployment
        run: |
          set -Eeuo pipefail
          ssh "$VPS_USER@$VPS_HOST" <<EOF
          set -Eeuo pipefail
          echo "PM2 status:"
          pm2 status | sed -n '1,80p'
          echo
          echo "Nginx status (short):"
          systemctl is-active nginx && nginx -t
          echo
          echo "Listen :8001"
          ss -H -ltn "( sport = :8001 )" | cat || true
          echo
          echo "Health:"
          curl -fsS http://127.0.0.1:8001/api/admin/health || echo "health NG"
          echo
          echo "Frontend index & one asset header:"
          curl -I https://zatint1991.com/kintai/ | sed -n '1,5p' || true
          # assetãƒ‘ã‚¹æŠ½å‡ºï¼ˆç›¸å¯¾/çµ¶å¯¾ã®ä¸¡å¯¾å¿œï¼‰
          PUB="$PUBLIC_DIR"
          ASSET=$(sed -n 's|.*src="\\([^"]*assets/[^"]*\\.js\\)".*|\\1|p' "$PUB/index.html" | head -n1)
          case "$ASSET" in
            /kintai/*)  URL="https://zatint1991.com$ASSET" ;;
            assets/*)   URL="https://zatint1991.com/kintai/$ASSET" ;;
            */assets/*) URL="https://zatint1991.com/$ASSET" ;;
            *)          URL="" ;;
          esac
          [ -n "$URL" ] && curl -I "$URL" | sed -n '1,5p' || echo "asset not detected"
          EOF
