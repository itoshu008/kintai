name: Deploy to VPS
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      APP_DIR: /home/zatint1991-hvt55/zatint1991.com
      BACKEND_DIR: /home/zatint1991-hvt55/zatint1991.com/backend
      FRONTEND_DIR: /home/zatint1991-hvt55/zatint1991.com/frontend
      PUBLIC_DIR: /home/zatint1991-hvt55/zatint1991.com/public/admin-dashboard-2024
      PM2_APP: kintai-api
      PM2_USER: itoshu
      PORT: "8001"
      NODE_ENV: production
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add host key (known_hosts)
        run: |
          mkdir -p ~/.ssh
          ssh-keygen -R "$VPS_HOST" 2>/dev/null || true
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Rsync sources (backend / frontend only)
        run: |
          set -e
          RSYNC_OPTS="-az -O --no-perms --no-group --omit-dir-times --delete \
            --exclude '.git' --exclude 'node_modules' \
            --exclude 'backups*/' --exclude 'data*/' \
            --exclude '.public_build*/' --exclude 'public-backup*/' \
            --exclude 'dist-ultimate*/' --exclude 'kintai*/'"
          RSYNC_SSH="ssh -o StrictHostKeyChecking=accept-new"

          rsync -e "$RSYNC_SSH" $RSYNC_OPTS ./backend/  "$VPS_USER@$VPS_HOST:$BACKEND_DIR/"  --rsync-path="sudo -u $PM2_USER rsync"
          rsync -e "$RSYNC_SSH" $RSYNC_OPTS ./frontend/ "$VPS_USER@$VPS_HOST:$FRONTEND_DIR/" --rsync-path="sudo -u $PM2_USER rsync"

      - name: Build backend & reload PM2
        run: |
          ssh "$VPS_USER@$VPS_HOST" "
            set -e
            cd \"$BACKEND_DIR\"
            sudo chown -R \"$PM2_USER\":\"$PM2_USER\" .
            npm install --omit=dev --no-audit --no-fund
            npm run build || true
            PORT=\"$PORT\" NODE_ENV=\"$NODE_ENV\" sudo -u \"$PM2_USER\" pm2 reload \"$PM2_APP\" \
              || PORT=\"$PORT\" NODE_ENV=\"$NODE_ENV\" sudo -u \"$PM2_USER\" pm2 start dist/index.js --name \"$PM2_APP\"
            sudo -u \"$PM2_USER\" pm2 save
          "

      - name: Build frontend & publish
        run: |
          ssh "$VPS_USER@$VPS_HOST" "
            set -e
            if [ -d \"$FRONTEND_DIR\" ]; then
              cd \"$FRONTEND_DIR\"
              sudo chown -R \"$PM2_USER\":\"$PM2_USER\" .
              npm install --no-audit --no-fund
              npm run build
              sudo rm -rf \"$PUBLIC_DIR\"
              sudo mkdir -p \"$PUBLIC_DIR\"
              sudo chown -R \"$PM2_USER\":\"$PM2_USER\" \"$PUBLIC_DIR\"
              rsync -a --delete \"$FRONTEND_DIR/dist/\" \"$PUBLIC_DIR/\"
              sudo nginx -t && sudo systemctl reload nginx
            else
              echo 'frontend/ not found. skip.'
            fi
          "

      - name: Write deployed commit
        run: |
          ssh "$VPS_USER@$VPS_HOST" "echo '${{ github.sha }} $(date -u +%FT%TZ)' | sudo -u $PM2_USER tee $APP_DIR/DEPLOYED_SHA.txt >/dev/null"