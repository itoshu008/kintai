name: Deploy to VPS (Simple)
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      APP_DIR: /home/zatint1991-hvt55/zatint1991.com
      BACKEND_DIR: /home/zatint1991-hvt55/zatint1991.com/backend
      FRONTEND_DIR: /home/zatint1991-hvt55/zatint1991.com/frontend
      PUBLIC_DIR: /home/zatint1991-hvt55/zatint1991.com/public/admin-dashboard-2024
      PM2_APP: kintai-api
      PM2_USER: itoshu
      PORT: "8001"
      NODE_ENV: production
      DEPLOY_USER: ${{ secrets.VPS_USER }}
      BUILD_USER: itoshu
      VPS_HOST: ${{ secrets.VPS_HOST }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add host key
        run: |
          echo "üîë Setting up SSH host key..."
          mkdir -p ~/.ssh
          ssh-keygen -R "$VPS_HOST" 2>/dev/null || true
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
          echo "‚úÖ SSH host key configured"

      - name: Test SSH connection
        run: |
          echo "üîç Testing SSH connection..."
          ssh "$BUILD_USER@$VPS_HOST" "echo 'SSH connection successful'"
          echo "‚úÖ SSH connection verified"

      - name: Deploy backend
        run: |
          echo "üöÄ Deploying backend..."
          ssh "$BUILD_USER@$VPS_HOST" <<EOF
          set -e
          cd "$BACKEND_DIR"
          echo "Installing backend dependencies..."
          npm ci --no-audit --no-fund || npm install --no-audit --no-fund
          echo "Building backend..."
          npm run build
          echo "Restarting PM2..."
          pm2 restart "$PM2_APP" || pm2 start dist/index.js --name "$PM2_APP"
          echo "‚úÖ Backend deployed"
          EOF

      - name: Deploy frontend
        run: |
          echo "üé® Deploying frontend..."
          ssh "$BUILD_USER@$VPS_HOST" <<EOF
          set -e
          cd "$FRONTEND_DIR"
          echo "Installing frontend dependencies..."
          npm ci --no-audit --no-fund || npm install --no-audit --no-fund
          echo "Building frontend..."
          npm run build
          echo "Publishing frontend..."
          sudo mkdir -p "$PUBLIC_DIR"
          rsync -az --delete dist/ "$PUBLIC_DIR/"
          sudo chown -R itoshu:itoshu "$PUBLIC_DIR"
          echo "‚úÖ Frontend deployed"
          EOF

      - name: Update nginx config
        run: |
          echo "‚öôÔ∏è Updating nginx config..."
          scp nginx-zatint1991-final.conf "$BUILD_USER@$VPS_HOST:/tmp/nginx-zatint1991.conf"
          ssh "$BUILD_USER@$VPS_HOST" <<EOF
          sudo cp /tmp/nginx-zatint1991.conf /etc/nginx/sites-enabled/zatint1991.com
          sudo nginx -t
          sudo systemctl reload nginx
          echo "‚úÖ nginx config updated"
          EOF

      - name: Health check
        run: |
          echo "üè• Running health check..."
          sleep 10
          for i in {1..5}; do
            if curl -f "http://$VPS_HOST:$PORT/api/admin/health"; then
              echo "‚úÖ Health check passed"
              break
            else
              echo "‚è≥ Waiting for service... ($i/5)"
              sleep 10
            fi
          done

      - name: Final verification
        run: |
          echo "üîç Final verification..."
          ssh "$BUILD_USER@$VPS_HOST" <<EOF
          echo "PM2 status:"
          pm2 status
          echo "Nginx status:"
          sudo systemctl status nginx --no-pager
          echo "Port $PORT status:"
          ss -tlnp | grep ":$PORT " || echo "Port $PORT not listening"
          EOF
