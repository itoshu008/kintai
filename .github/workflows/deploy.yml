name: Deploy to VPS (SSH)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      group: prod-deploy
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preflight - Check secrets
        run: |
          echo "ğŸ” Checking secrets..."
          if [ -n "${{ secrets.SSH_HOST }}" ]; then
            echo "SSH_HOST: SET"
          else
            echo "SSH_HOST: MISSING"
          fi
          if [ -n "${{ secrets.SSH_USER }}" ]; then
            echo "SSH_USER: SET"
          else
            echo "SSH_USER: MISSING"
          fi
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "SSH_PRIVATE_KEY: SET"
          else
            echo "SSH_PRIVATE_KEY: MISSING"
          fi
          if [ -n "${{ secrets.SSH_PORT }}" ]; then
            echo "SSH_PORT: SET"
          else
            echo "SSH_PORT: MISSING"
          fi
          if [ -n "${{ secrets.SUDO_PASS }}" ]; then
            echo "SUDO_PASS: SET"
          else
            echo "SUDO_PASS: MISSING"
          fi
          echo "âš ï¸ If any secrets are MISSING, please set them in GitHub Settings > Secrets and variables > Actions"
          echo "ğŸ“‹ Required Secrets:"
          echo "  - SSH_HOST: VPSã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‰ãƒ¡ã‚¤ãƒ³"
          echo "  - SSH_USER: SSHæ¥ç¶šãƒ¦ãƒ¼ã‚¶ãƒ¼å"
          echo "  - SSH_PRIVATE_KEY: SSHç§˜å¯†éµ"
          echo "  - SSH_PORT: SSHãƒãƒ¼ãƒˆç•ªå· (é€šå¸¸22)"
          echo "  - SUDO_PASS: sudoãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          SUDO_PASS: ${{ secrets.SUDO_PASS }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          request_pty: true
          envs: SUDO_PASS
          script: |
            set -Eeuo pipefail
            : "${SUDO_PASS:?SUDO_PASS is not set}"

            APP_DIR="/home/zatint1991-hvt55/zatint1991.com"
            BACKEND_DIR="$APP_DIR/backend"
            FRONTEND_DIR="$APP_DIR/frontend"
            PUBLIC_DIR="$APP_DIR/public/kintai"   # â˜… Nginx ã¨æƒãˆã‚‹
            BUILD_USER="itoshu"
            PM2_APP="kintai-api"
            HOST="127.0.0.1"
            PORT="8001"

            echo "ğŸ‘¤ fix perms (including .git)"
            printf '%s\n' "$SUDO_PASS" | sudo -S -p '' -k chown -R "$BUILD_USER:$BUILD_USER" "$APP_DIR"
            printf '%s\n' "$SUDO_PASS" | sudo -S -p '' -k chown -R "$BUILD_USER:$BUILD_USER" "/home/$BUILD_USER/.npm" "/home/$BUILD_USER/.pm2" || true
            printf '%s\n' "$SUDO_PASS" | sudo -S -p '' -k chown -R "$BUILD_USER:$BUILD_USER" "$APP_DIR/.git" || true
            find "$APP_DIR" -type d -exec chmod 775 {} \; ; find "$APP_DIR" -type f -exec chmod 664 {} \;

            echo "ğŸŒ¿ git sync"
            cd "$APP_DIR"
            if [ -d .git ]; then
              git config --global --add safe.directory "$APP_DIR" || true
              git fetch --all -p
              git reset --hard origin/main
              git clean -fdx
            else
              echo "âš ï¸ .git ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆã‚µãƒ¼ãƒã«ã‚³ãƒ”ãƒ¼é…ç½®æ–¹å¼ãªã‚‰ç„¡è¦–ï¼‰"
            fi

            echo "ğŸ§± backend build"
            cd "$BACKEND_DIR"
            if [ -f package-lock.json ]; then
              npm ci --no-fund --no-audit || npm install --no-fund --no-audit
            else
              npm install --no-fund --no-audit
            fi
            npm run build

            echo "ğŸš€ pm2 restart"
            pm2 delete "$PM2_APP" 2>/dev/null || true
            HOST="$HOST" PORT="$PORT" NODE_ENV=production pm2 start "$BACKEND_DIR/dist/server.js" --name "$PM2_APP" --update-env
            pm2 save

            echo "ğŸ©º health (60s)"
            ok=""
            for i in $(seq 1 30); do
              if curl -fsS "http://$HOST:$PORT/api/admin/health" >/dev/null; then
                echo "âœ… Backend OK"; ok="yes"; break
              fi
              echo "  waiting... ($i/30)"; sleep 2
            done
            [ -z "$ok" ] && { echo "âŒ Backend NG"; exit 1; }

            echo "ğŸ¨ frontend build"
            cd "$FRONTEND_DIR"
            if [ -f package-lock.json ]; then
              npm ci --no-fund --no-audit || npm install --no-fund --no-audit
            else
              npm install --no-fund --no-audit
            fi
            npm run build

            echo "ğŸšš publish"
            mkdir -p "$PUBLIC_DIR"
            rsync -az --delete "dist/" "$PUBLIC_DIR/"

            echo "ğŸŒ€ nginx reload"
            printf '%s\n' "$SUDO_PASS" | sudo -S -p '' -k nginx -t
            printf '%s\n' "$SUDO_PASS" | sudo -S -p '' -k systemctl reload nginx

            echo "ğŸ”§ sudoers åˆå›è¨­å®šï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã°ä½œæˆï¼‰"
            if ! printf '%s\n' "$SUDO_PASS" | sudo -S -p '' -k test -f /etc/sudoers.d/kintai-deploy; then
              # sudoersè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
              echo "Defaults:itoshu !requiretty" | printf '%s\n' "$SUDO_PASS" | sudo -S -p '' -k tee /etc/sudoers.d/kintai-deploy >/dev/null
              echo "itoshu ALL=(root) NOPASSWD: /usr/bin/chown -R itoshu:itoshu /home/zatint1991-hvt55/zatint1991.com/*, /usr/sbin/nginx, /bin/systemctl" | printf '%s\n' "$SUDO_PASS" | sudo -S -p '' -k tee -a /etc/sudoers.d/kintai-deploy >/dev/null
              printf '%s\n' "$SUDO_PASS" | sudo -S -p '' -k visudo -c
              echo "âœ… sudoers installed"
            else
              echo "â„¹ï¸ sudoers already present"
            fi

            echo "ğŸ” verify"
            curl -I "https://zatint1991.com/kintai/" | sed -n '1,6p' || echo "âš ï¸ Frontend access test failed"
            curl -fsS "http://$HOST:$PORT/api/admin/health" && echo "âœ… deploy done" || echo "âš ï¸ Backend health check failed"
