name: Deploy to VPS
on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP_DIR: /home/zatint1991-hvt55/zatint1991.com
      BACKEND_DIR: /home/zatint1991-hvt55/zatint1991.com/backend
      FRONTEND_DIR: /home/zatint1991-hvt55/zatint1991.com/frontend
      PUBLIC_DIR: /home/zatint1991-hvt55/zatint1991.com/public/kintai
      PM2_APP: kintai-api
      PM2_USER: itoshu
      PORT: "8001"
      NODE_ENV: production

    steps:
      - uses: actions/checkout@v4
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add server to known_hosts
        run: ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Rsync sources to server
        run: |
          rsync -az --delete --exclude ".git" --exclude "node_modules" \
            ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ env.APP_DIR }}/

      - name: Build backend & reload PM2
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} '
            set -e
            cd ${BACKEND_DIR}
            sudo chown -R '"${{ env.PM2_USER }}"':'" ${env.PM2_USER} "' .
            npm ci --omit=dev || npm install --omit=dev
            npm run build || true
            PORT='${PORT}' NODE_ENV='${NODE_ENV}' sudo -u '"${{ env.PM2_USER }}"' pm2 reload '"${{ env.PM2_APP }}"' \
              || PORT='${PORT}' NODE_ENV='${NODE_ENV}' sudo -u '"${{ env.PM2_USER }}"' pm2 start dist/server.js --name '"${{ env.PM2_APP }}"'
            sudo -u '"${{ env.PM2_USER }}"' pm2 save
          '

      - name: Build frontend & publish (if exists)
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} '
            set -e
            if [ -d ${FRONTEND_DIR} ]; then
              cd ${FRONTEND_DIR}
              sudo chown -R '"${{ env.PM2_USER }}"':'" ${env.PM2_USER} "' .
              npm ci || npm install
              npm run build
              sudo rm -rf ${PUBLIC_DIR}
              sudo mkdir -p ${PUBLIC_DIR}
              sudo chown -R '"${{ env.PM2_USER }}"':'" ${env.PM2_USER} "' ${PUBLIC_DIR}
              rsync -a --delete ${FRONTEND_DIR}/dist/ ${PUBLIC_DIR}/
              sudo nginx -t && sudo systemctl reload nginx
            else
              echo "frontend/ not found. skip."
            fi
          '

