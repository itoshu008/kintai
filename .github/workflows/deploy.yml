name: Deploy to VPS (Minimal)
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Deploy everything
        run: |
          echo "🚀 Starting minimal deployment..."
          
          # SSH設定
          mkdir -p ~/.ssh
          echo "Host $VPS_HOST" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
          chmod 600 ~/.ssh/config
          
          # デプロイ実行
          ssh $VPS_USER@$VPS_HOST << 'EOF'
          set -e
          
          echo "📁 Setting up directories..."
          mkdir -p /home/zatint1991-hvt55/zatint1991.com/{backend,frontend,public/admin-dashboard-2024}
          
          echo "🔄 Updating code..."
          cd /home/zatint1991-hvt55/zatint1991.com
          git fetch origin
          git reset --hard origin/main
          
          echo "🚀 Deploying backend..."
          cd backend
          npm install --production
          npm run build
          pm2 stop kintai-api || true
          pm2 delete kintai-api || true
          pm2 start dist/index.js --name kintai-api
          pm2 save
          
          echo "🎨 Deploying frontend..."
          cd ../frontend
          npm install
          npm run build
          rsync -az --delete dist/ /home/zatint1991-hvt55/zatint1991.com/public/admin-dashboard-2024/
          chown -R itoshu:itoshu /home/zatint1991-hvt55/zatint1991.com/public/admin-dashboard-2024
          
          echo "⚙️ Updating nginx..."
          cp nginx-zatint1991-final.conf /etc/nginx/sites-enabled/zatint1991.com
          nginx -t
          systemctl reload nginx
          
          echo "✅ Deployment completed!"
          EOF

      - name: Verify deployment
        run: |
          echo "🔍 Verifying deployment..."
          sleep 10
          ssh $VPS_USER@$VPS_HOST << 'EOF'
          echo "PM2 status:"
          pm2 status
          echo "Nginx status:"
          systemctl status nginx --no-pager | head -5
          echo "Port 8001:"
          ss -tlnp | grep ":8001 " || echo "Port 8001 not listening"
          echo "Frontend files:"
          ls -la /home/zatint1991-hvt55/zatint1991.com/public/admin-dashboard-2024/ | head -5
          EOF
