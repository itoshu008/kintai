name: Deploy to VPS (Final)
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
      APP_DIR: /home/zatint1991-hvt55/zatint1991.com
      BACKEND_DIR: /home/zatint1991-hvt55/zatint1991.com/backend
      FRONTEND_DIR: /home/zatint1991-hvt55/zatint1991.com/frontend
      PUBLIC_DIR: /home/zatint1991-hvt55/zatint1991.com/public/admin-dashboard-2024
      PM2_APP: kintai-api
      PM2_HOME: /home/itoshu/.pm2
      PORT: "8001"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Configure SSH
        run: |
          echo "🔧 Configuring SSH..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          cat > ~/.ssh/config << EOF
          Host $VPS_HOST
            HostName $VPS_HOST
            User $VPS_USER
            Port ${VPS_SSH_PORT:-22}
            ConnectTimeout 60
            ServerAliveInterval 15
            ServerAliveCountMax 6
            TCPKeepAlive yes
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
            Compression yes
            CompressionLevel 6
            BatchMode yes
          EOF
          
          chmod 600 ~/.ssh/config
          echo "✅ SSH configuration completed"

      - name: Test SSH
        run: |
          echo "🔍 Testing SSH connection..."
          P=${VPS_SSH_PORT:-22}
          echo "Testing SSH to $VPS_USER@$VPS_HOST port $P ..."
          ssh "$VPS_USER@$VPS_HOST" "echo '✅ SSH OK'"

      - name: Deploy using single script
        run: |
          echo "🚀 Deploying using single script..."
          ssh "$VPS_USER@$VPS_HOST" "bash -s" < deploy-all.sh

      - name: Final verification
        run: |
          echo "🔍 Final verification..."
          ssh "$VPS_USER@$VPS_HOST" << 'EOF'
          echo "=== Final Status ==="
          echo "PM2 status:"
          pm2 status || echo "PM2 status check failed"
          echo
          echo "Nginx status:"
          systemctl is-active nginx || echo "Nginx status check failed"
          echo
          echo "Port 8001 status:"
          ss -H -ltn "( sport = :8001 )" | cat || echo "Port 8001 not listening"
          echo
          echo "Backend health:"
          curl -fsS "http://127.0.0.1:8001/api/admin/health" || echo "Health check failed"
          echo
          echo "Frontend access test:"
          curl -I "https://zatint1991.com/kintai/" | head -5 || echo "Frontend access test failed"
          echo
          echo "API through nginx:"
          curl -fsS "https://zatint1991.com/api/admin/health" || echo "API through nginx failed"
          EOF
