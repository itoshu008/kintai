name: Deploy to VPS (SSH)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      group: prod-deploy
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -Eeuo pipefail
            
            # ç’°å¢ƒè¨­å®š
            APP_DIR="/home/zatint1991-hvt55/zatint1991.com"
            BACKEND_DIR="$APP_DIR/backend"
            FRONTEND_DIR="$APP_DIR/frontend"
            PUBLIC_DIR="$APP_DIR/public/admin-dashboard-2024"
            BUILD_USER="itoshu"
            PM2_APP="kintai-api"
            HOST="127.0.0.1"
            PORT="8001"
            
            echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹"
            
            # æ¨©é™è¨­å®š
            echo "ğŸ‘¤ æ¨©é™è¨­å®š"
            sudo chown -R "$BUILD_USER:$BUILD_USER" "$APP_DIR" "/home/$BUILD_USER/.npm" "/home/$BUILD_USER/.pm2" || true
            
            # GitåŒæœŸ
            echo "ğŸŒ¿ GitåŒæœŸ"
            cd "$APP_DIR"
            if [ -d .git ]; then
              git fetch --all -p
              git reset --hard "origin/main"
            else
              echo "âš ï¸ .git ãŒã‚ã‚Šã¾ã›ã‚“"
            fi
            
            # Backendãƒ“ãƒ«ãƒ‰
            echo "ğŸ§± Backendãƒ“ãƒ«ãƒ‰"
            cd "$BACKEND_DIR"
            npm ci --no-fund --no-audit || npm install --no-fund --no-audit
            npm run build
            
            # PM2å†èµ·å‹•
            echo "ğŸš€ PM2å†èµ·å‹•"
            pm2 delete "$PM2_APP" 2>/dev/null || true
            HOST="$HOST" PORT="$PORT" NODE_ENV=production pm2 start "$BACKEND_DIR/dist/server.js" --name "$PM2_APP" --update-env
            pm2 save
            
            # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
            echo "ğŸ©º ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"
            ok=""
            for i in $(seq 1 30); do
              if curl -fsS "http://$HOST:$PORT/api/admin/health" >/dev/null; then
                echo "âœ… Backendæ­£å¸¸"
                ok="yes"; break
              fi
              echo "  å¾…æ©Ÿä¸­... ($i/30)"
              sleep 2
            done
            [ -z "$ok" ] && { echo "âŒ Backendç•°å¸¸"; exit 1; }
            
            # Frontendãƒ“ãƒ«ãƒ‰
            echo "ğŸ¨ Frontendãƒ“ãƒ«ãƒ‰"
            cd "$FRONTEND_DIR"
            npm ci --no-fund --no-audit || npm install --no-fund --no-audit
            npm run build
            
            # å…¬é–‹
            echo "ğŸšš å…¬é–‹"
            mkdir -p "$PUBLIC_DIR"
            rsync -az --delete "dist/" "$PUBLIC_DIR/"
            
            # Nginxå†èª­ã¿è¾¼ã¿
            echo "ğŸŒ€ Nginxå†èª­ã¿è¾¼ã¿"
            sudo nginx -t && sudo systemctl reload nginx
            
            # æ¤œè¨¼
            echo "ğŸ” æ¤œè¨¼"
            curl -I "https://zatint1991.com/kintai/" | sed -n '1,6p'
            curl -fsS "http://$HOST:$PORT/api/admin/health" && echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
