name: Deploy to VPS (SSH)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: itoshu
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || '22' }}
          script: |
            # デプロイスクリプト実行
            cd /home/itoshu/projects/kintai/kintai
            
            # 最新コードを取得
            git fetch origin
            git reset --hard origin/main
            
            # バックエンドのセットアップ
            cd backend
            cp env.production .env
            npm ci --production
            npm run build
            
            # MySQLデータベースの初期化
            echo "Initializing MySQL database..."
            mysql -u itoshu -pzatint_6487 -e "CREATE DATABASE IF NOT EXISTS kintai;"
            
            # PM2で再起動
            pm2 stop kintai-api 2>/dev/null || true
            pm2 delete kintai-api 2>/dev/null || true
            pm2 start pm2.config.cjs --env production
            
            # データベーステーブルの初期化
            sleep 5
            curl -X POST http://localhost:4000/api/mysql/init || echo "Database init failed, continuing..."
            
            # フロントエンドのセットアップ
            cd ../frontend
            npm ci --production
            npm run build
            
            # Nginx設定の更新
            sudo cp /home/itoshu/projects/kintai/kintai/docs/nginx-production.conf /etc/nginx/sites-available/zatint1991.com
            sudo nginx -t && sudo systemctl reload nginx
            
            # ヘルスチェック
            sleep 10
            curl -f http://localhost:4000/api/mysql/health || exit 1
            
            # PM2ステータス確認
            pm2 status