#!/bin/bash

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¿®æ­£ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ä½¿ç”¨æ–¹æ³•: bash deploy-health-fix.sh

set -e

echo "ğŸš€ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¿®æ­£ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹..."

# 1. æœ€æ–°ã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
echo "ğŸ“¥ æœ€æ–°ã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ä¸­..."
git fetch origin
git reset --hard origin/main

# 2. ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
cd backend
npm ci
cd ../frontend
npm ci
cd ..

# 3. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰
echo "ğŸ”¨ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
cd backend
npm run build
cd ..

# 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰
echo "ğŸ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
cd frontend
npm run build
cd ..

# 5. PM2ã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’å†èµ·å‹•
echo "ğŸ”„ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’å†èµ·å‹•ä¸­..."
pm2 restart kintai-api || pm2 start backend/dist/index.js --name kintai-api

# 6. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆ
echo "ğŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆä¸­..."
sleep 3

# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ
echo "ãƒ­ãƒ¼ã‚«ãƒ«ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯:"
curl -s http://localhost:8000/api/admin/health | jq . || echo "ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå¤±æ•—"

# æœ¬ç•ªãƒ†ã‚¹ãƒˆ
echo "æœ¬ç•ªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯:"
curl -s https://zatint1991.com/api/admin/health | jq . || echo "æœ¬ç•ªãƒ†ã‚¹ãƒˆå¤±æ•—"

echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼"
echo "ğŸ“Š PM2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:"
pm2 status

echo "ğŸ“‹ ãƒ­ã‚°ç¢ºèª:"
echo "pm2 logs kintai-api --lines 20"
