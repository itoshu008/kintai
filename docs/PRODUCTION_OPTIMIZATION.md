# 本番環境最適化設定

## 🚀 最適化されたサーバー構成

### 概要
勤怠管理システムの本番環境用に最適化された設定ファイルとデプロイメント手順を提供します。

## 📁 設定ファイル構成

### 1. PM2設定 (`backend/pm2.config.cjs`)
- **クラスターモード**: 2インスタンスで負荷分散
- **ポート**: 4000（統一）
- **メモリ制限**: 500MB
- **自動再起動**: 有効
- **ログ管理**: 統合ログファイル
- **環境変数**: 本番用データベース設定

### 2. Nginx設定 (`docs/nginx-production.conf`)
- **プロキシ**: ポート4000へのAPIリクエスト
- **キャッシュ**: 静的ファイルの最適化
- **セキュリティ**: セキュリティヘッダー設定
- **ログ**: アクセス・エラーログ分離
- **タイムアウト**: 適切なタイムアウト設定

### 3. デプロイメント設定
- **GitHub Actions**: 自動デプロイ
- **デプロイスクリプト**: `scripts/deploy-production.sh`
- **ヘルスチェック**: 自動検証
- **ロールバック**: エラー時の自動停止

## 🔧 最適化ポイント

### パフォーマンス
- **クラスターモード**: CPUコアを活用した並列処理
- **静的ファイルキャッシュ**: 1年間のキャッシュ設定
- **プロキシバッファ**: 効率的なリクエスト処理
- **メモリ制限**: メモリリーク防止

### セキュリティ
- **セキュリティヘッダー**: XSS、CSRF対策
- **HTTPS対応**: Let's Encrypt設定例
- **ファイルサイズ制限**: 10MB制限
- **タイムアウト設定**: DoS攻撃対策

### 監視・ログ
- **統合ログ**: PM2による統合ログ管理
- **ヘルスチェック**: 自動ヘルスチェック
- **エラー追跡**: 詳細なエラーログ
- **ステータス監視**: PM2ステータス確認

## 🚀 デプロイ手順

### 自動デプロイ（推奨）
```bash
# GitHub Actionsで自動デプロイ
git push origin main
```

### 手動デプロイ
```bash
# サーバー上で実行
bash scripts/deploy-production.sh
```

### 個別セットアップ
```bash
# 1. バックエンド
cd backend
cp env.production .env
npm ci --production
npm run build
pm2 start pm2.config.cjs --env production

# 2. フロントエンド
cd ../frontend
npm ci --production
npm run build

# 3. Nginx設定
sudo cp docs/nginx-production.conf /etc/nginx/sites-available/zatint1991.com
sudo nginx -t && sudo systemctl reload nginx
```

## 📊 期待される性能

### レスポンス時間
- **API**: < 200ms
- **静的ファイル**: < 100ms
- **初回ロード**: < 2s

### スループット
- **同時接続**: 100+ ユーザー
- **リクエスト/秒**: 100+ RPS
- **メモリ使用量**: < 500MB/インスタンス

### 可用性
- **稼働率**: 99.9%
- **ダウンタイム**: < 1分/月
- **自動復旧**: 30秒以内

## 🔍 トラブルシューティング

### よくある問題
1. **ポート競合**: ポート4000が使用中
2. **メモリ不足**: メモリ制限に達した
3. **データベース接続**: MySQL接続エラー
4. **Nginx設定**: 設定ファイルの構文エラー

### 解決方法
```bash
# ポート確認
lsof -i :4000

# PM2ステータス
pm2 status

# ログ確認
pm2 logs kintai-api

# Nginx設定テスト
sudo nginx -t
```

## 📈 監視・メンテナンス

### 日常監視
```bash
# ステータス確認
pm2 status
pm2 logs kintai-api --lines 20

# ヘルスチェック
curl http://localhost:4000/api/admin/health
```

### 定期メンテナンス
- **ログローテーション**: 週次
- **依存関係更新**: 月次
- **セキュリティパッチ**: 随時
- **バックアップ確認**: 日次

## 🎯 次のステップ

1. **HTTPS設定**: Let's Encrypt証明書の設定
2. **監視システム**: Prometheus + Grafana導入
3. **ログ管理**: ELK Stack導入
4. **CI/CD強化**: テスト自動化
5. **スケーリング**: ロードバランサー導入
