# PM2èµ·å‹•ã‚³ãƒãƒ³ãƒ‰ã‚¬ã‚¤ãƒ‰ - æœ€é©åŒ–ç‰ˆ

## ğŸš€ æœ€é©åŒ–ã•ã‚ŒãŸPM2èµ·å‹•ã‚³ãƒãƒ³ãƒ‰

### 1. åŸºæœ¬çš„ãªèµ·å‹•ã‚³ãƒãƒ³ãƒ‰ï¼ˆæ¨å¥¨ï¼‰

```bash
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd backend

# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
cp env.production .env

# ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm ci --production

# ãƒ“ãƒ«ãƒ‰
npm run build

# PM2è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§èµ·å‹•ï¼ˆæ¨å¥¨ï¼‰
pm2 start pm2.config.cjs --env production
```

### 2. æ‰‹å‹•èµ·å‹•ã‚³ãƒãƒ³ãƒ‰

```bash
# æ‰‹å‹•ã§PM2èµ·å‹•ï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãªã—ï¼‰
pm2 start dist/index.js --name kintai-api --env production --instances 2 --exec-mode cluster
```

### 3. æ—¢å­˜ãƒ—ãƒ­ã‚»ã‚¹ã®ç®¡ç†

```bash
# æ—¢å­˜ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
pm2 stop kintai-api

# æ—¢å­˜ãƒ—ãƒ­ã‚»ã‚¹ã‚’å‰Šé™¤
pm2 delete kintai-api

# å…¨ãƒ—ãƒ­ã‚»ã‚¹ã‚’å†èµ·å‹•
pm2 restart all

# å…¨ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
pm2 stop all
```

### 4. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª

```bash
# PM2ãƒ—ãƒ­ã‚»ã‚¹ä¸€è¦§
pm2 status

# ãƒ­ã‚°ç¢ºèª
pm2 logs kintai-api --lines 20

# è©³ç´°æƒ…å ±
pm2 show kintai-api
```

### 5. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl http://localhost:4000/api/admin/health

# æœ¬ç•ªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl https://zatint1991.com/api/admin/health
```

### 6. ãƒãƒ¼ãƒˆç¢ºèª

```bash
# ãƒãƒ¼ãƒˆ4000ã®ä½¿ç”¨çŠ¶æ³
netstat -an | grep :4000

# ã¾ãŸã¯
lsof -i :4000
```

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼: Script not found

**åŸå› **: é–“é•ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•**:
```bash
# âŒ é–“é•ã„
pm2 start server.js --name kintai-api

# âœ… æ­£ã—ã„
pm2 start dist/index.js --name kintai-api --env production
```

### ã‚¨ãƒ©ãƒ¼: Cannot find module

**åŸå› **: ä¾å­˜é–¢ä¿‚ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•**:
```bash
cd backend
npm ci
npm run build
pm2 start dist/index.js --name kintai-api --env production
```

### ã‚¨ãƒ©ãƒ¼: Port already in use

**åŸå› **: ãƒãƒ¼ãƒˆ8001ãŒæ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•**:
```bash
# æ—¢å­˜ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
pm2 stop kintai-api
pm2 delete kintai-api

# ã¾ãŸã¯åˆ¥ã®ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨
pm2 start dist/index.js --name kintai-api --env production -- --port 8002
```

## ğŸ“‹ å®Œå…¨ãªãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

```bash
# 1. æœ€æ–°ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
git fetch origin
git reset --hard origin/main

# 2. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
cd backend
cp env.production .env
npm ci
npm run build

# 3. PM2ã§èµ·å‹•
pm2 stop kintai-api 2>/dev/null || true
pm2 delete kintai-api 2>/dev/null || true
pm2 start dist/index.js --name kintai-api --env production

# 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
cd ../frontend
npm ci
npm run build

# 5. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl http://localhost:4000/api/admin/health
```

## ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹çµæœ

**æ­£å¸¸ãªå ´åˆ**:
```json
{
  "ok": true,
  "status": "healthy",
  "timestamp": "2025-01-09T12:00:00.000Z",
  "version": "1.0.0",
  "environment": "production"
}
```

**PM2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**:
```
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id  â”‚ name        â”‚ namespace   â”‚ version â”‚ mode    â”‚ pid      â”‚ uptime â”‚ â†º    â”‚ status    â”‚ cpu      â”‚ mem      â”‚ user     â”‚ watching â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0   â”‚ kintai-api  â”‚ default     â”‚ 1.0.0   â”‚ fork    â”‚ 12345    â”‚ 2m     â”‚ 0    â”‚ online    â”‚ 0%       â”‚ 45.2mb   â”‚ user     â”‚ disabled â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
